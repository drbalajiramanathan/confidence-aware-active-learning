<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Model Test</title>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@latest"></script>
</head>
<body>
   <h1>TF.js Model Loader</h1>
    <input type="file" id="imageUpload" accept="image/*">
    <br>
    <img id="uploadedImage" alt="Upload preview" style="width: 224px; height: 224px; margin-top: 10px; border: 1px solid #ccc;">

    <p id="status">Loading model...</p>

    <script>
    const status = document.getElementById('status');
    const imageUpload = document.getElementById('imageUpload');
    const uploadedImage = document.getElementById('uploadedImage');
    let model; // Store the loaded model globally

    // 1. Image Preprocessing Function
    function preprocessImage(imgElement) {
        // Use tf.browser.fromPixels to convert the image to a tensor
        // Resize it to 224x224
        // Rescale pixel values from 0-255 to 0-1 (as done in training)
        // Expand dimensions to create a batch of 1: [1, 224, 224, 3]
        return tf.tidy(() => {
            const tensor = tf.browser.fromPixels(imgElement)
                .resizeNearestNeighbor([224, 224])
                .toFloat()
                .div(tf.scalar(255.0)) // Rescale to 1./255
                .expandDims(); // Add batch dimension
            return tensor;
        });
    }

    // 2. Event listener for file upload
    imageUpload.addEventListener('change', event => {
        const file = event.target.files[0];
        if (file) {
            const reader = new FileReader();
            reader.onload = e => {
                uploadedImage.src = e.target.result;
                uploadedImage.style.display = 'block';
                status.innerText = 'Image loaded. Ready for prediction.';
            };
            reader.readAsDataURL(file);
        }
    });

    // 3. Model Loading Function (Slightly modified)
    async function loadModel() {
        try {
            const modelURL = './model/model.json';
            console.log('Attempting to load model from:', modelURL);

            // Assign to the global 'model' variable
            model = await tf.loadLayersModel(modelURL); 

            console.log('Model Loaded Successfully');
            status.innerText = 'Model Loaded. Please upload an image.';
            model.summary();

        } catch (error) {
            console.error('Error loading model:', error);
            status.innerText = 'Error loading model. See console (F12).';
        }
    }

    // Run the model loader
    loadModel();
</script>
</body>
</html>
